---
title: 尚硅谷-谷粒商城-持续更新
date: 2022-03-18 15:34:15
tags: 商城
categories: 项目
description: 谷粒商城是从后端到前端，囊括了开发的打包、部署、上线、运维的一整套流程的完整项目
---
<meta name="referrer" content="no-referrer"/>

![river-gb44d67b82_1280](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204072146144.png)

<!--more-->

# docker 安装

## docker 安装MySQL

1. 下载镜像

   ```shell
   docker pull mysql:5.7
   ```

2. 创建实例

   ```sh
   docker run -p 3307:3306 --name mysql \
   -v /mydata/mysql/log:/var/log/mysql \
   -v /mydata/mysql/data:/var/lib/mysql \
   -v /mydata/mysql/conf:/etc/mysql \
   -e MYSQL_ROOT_PASSWORD=root \
   -d mysql:5.7
   ```

   参数说明：

   - -p 3306:3306：-p 主机端口:容器端口，将容器的3306端口映射到主机的3306端口
   - -v /mydata/mysql/conf:/etc/mysql：将配置文件夹挂载到主机
   - -v /mydata/mysql/log:/var/log/mysql：将日志文件夹挂载到主机
   - -v /mydata/mysql/data:/var/lib/mysql：将配置文件夹挂载到主机
   - -e MYSQL_ROOT_PASSWORD=root：初始化root用户密码
   - -d mysql:5.7：表示后台运行(-d) 镜像mysql:5.7   -->查看镜像docekr images

3. 进去docker 容器

   ``` sh
   root@af26dd647c9a:/# docker exec -it mysql /bin/bash
   root@af26dd647c9a:/# whereis mysql
   mysql: /usr/bin/mysql /usr/lib/mysql /etc/mysql /usr/share/mysql
   ```

4. mysql配置 my.cnf

   ```sh
   [root@lingzx conf]# vi /mydata/mysql/conf/my.cnf
   ```

   ```sh
   [client]
   default-character-set=utf8
   
   [mysql]
   default-character-set=utf8
   
   [mysqld]
   init_connect='SET collation_connection=utf8_unicode_ci'
   init_connect='SET NAMES utf8'
   character-set-server=utf8
   collation-server=utf8_unicode_ci
   skip-character-set-client-handshake
   skip-name-resolve
   lower_case_table_names=1
   ```

5. 查看docker中MySQL的配置

   ```sh
   cd /etc/mysql
   cat my.cnf
   ```

6. 开机自启

   ```sh
   docker update mysql --restart=always
   ```

   

## docker 安装Redis

1. 下载redis 镜像

   ``` sh 
   docker pull redis
   ```

2. 创建实例并启动

   ```sh
   # 由于 redis容器 /etc/redis目录下没有 redis.conf ，所以需要我们预先在主机上创建一个 redis.conf
   mkdir -p /mydata/redis/conf
   touch /mydata/redis/conf/redis.conf
   
   docker run -p 6379:6379 --name redis \
   -v /mydata/redis/data:/data \
   -v /mydata/redis/conf/redis.conf:/etc/redis/redis.conf \
   -d redis redis-server /etc/redis/redis.conf
   
   # 连接 docker中的 redis的控制台
   docker exec -it redis redis-cli
   ```

3. 配置持久化

   > 当前版本的redis默认配置了【文件追加写持久化】aof

   ```sh
   vi /mydata/redis/redis.conf
   
   appendonly yes
   
   docker restart redis
   ```

4. 开机自启

   ```sh
   docker update redis --restart=always
   ```

   

# 统一环境

## Maven 3.6.1

> 链接: https://pan.baidu.com/s/1Jd5EAXADSEFop2QT8sxzBA 提取码: 38iw 复制这段内容后打开百度网盘手机App，操作更方便哦

配置阿里云镜像

```xml
<mirrors>
	<mirror>
      <id>nexus-aliyun</id>
      <mirrorOf>central</mirrorOf>
      <name>Nexus aliyun</name>
      <url>http://maven.aliyun.com/nexus/content/groups/public/</url>
    </mirror>
</mirrors> 
```

配置 JDK 1.8 编译环境

```xml
<profiles>
  <profile>
    <id>jdk-1.8</id>
    <activation>
      <activeByDefault>true</activeByDefault>
      <jdk>1.8</jdk>
    </activation>
    <properties>
      <maven.compile.source>1.8</maven.compile.source>
      <maven.compile.target>1.8</maven.compile.target>
      <maven.compile.compilerVersion>1.8</maven.compile.compilerVersion>
    </properties>
  </profile>
</profiles>
```

配置本地仓库

```xml
<localRepository>D:\Program Files\Maven\LocalWareHouse</localRepository>
```

## idea 安装插件

- lombok
- MybatisX

## Vscode 安装配置

- Auto Close Tag
- Auto Rename Tag
- Chinese (Simplified)
- ESLint
- HTML CSS Support
- HTML Snippets
- JavaScript（ES6）
- Live Server
- open in browser
- Vetur

## 安装配置 git

1. 下载 git：https://git-scm.com

2. 配置 git ，进入git bash

   ```sh
   # 配置用户名
   git config --global user.name 'username'
   # 配置邮箱
   git config --global user.email 'username@email.com'
   ```

3. 配置 shh 免密登录，进入git bash

   ```sh
   ssh-keygen -t rsa -C 'xx@xxx.com'
   ```

    三次回车，查找 id_rsa 和 id_rsa.pub

4. 登录 gitee，在设置里面找到 SSH KEY 将 .pub 文件的内容粘贴进去

   ```sh
   # 查看是否成功
   ssh -T git@gitee.com 
   ```

# 创建项目

1. 商品服务、仓储服务、订单服务、优惠券服务、用户服务

   共用：

   1. web 、openfeign
   2. 每个服务，包名 **com.atguigu.gulimall**.xxx(product/order/ware/coupon/member)
   3. 模块名：gulimall-coupon

2. 添加pom文件

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
       <modelVersion>4.0.0</modelVersion>
       <groupId>com.atguigu.gulimall</groupId>
       <artifactId>gulimall</artifactId>
       <version>0.0.1-SNAPSHOT</version>
       <name>gulimall</name>
       <description>聚合服务</description>
       <packaging>pom</packaging>
       <modules>
           <module>gulimall-coupon</module>
           <module>gulimall-member</module>
           <module>gulimall-order</module>
           <module>gulimall-product</module>
           <module>gulimall-ware</module>
       </modules>
   </project>
   ```

3. 设置忽略提交内容 .gitgnore

   ```sh
   **/mvnw
   **/mvnw.cmd
   
   **/.mvn
   **/target/
   
   .idea
   **/.gitignore
   ```

   ![image-20220323234601504](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202203232346905.png) 

4. 提交并推送到仓库

## 数据库设计 PowerDesigner

1. ![image-20220324004223247](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202203240042296.png) 

7. ![image-20220324004234654](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202203240042710.png) 

2. 每个微服务创建自己的数据库

## 人人开源快速开发

### 后端管理 renren-fast

1. 克隆项目

   > git clone git@gitee.com:renrenio/renren-fast.git
   
2. 将renren-fast 放在gulimall项目pom中 module

   > <module>renren-fast</module>

3. 新增数据库 gulimall_admin

4. 修改pom

   1. 关联gulimall

      ```xml
      <parent>
          <groupId>org.springframework.boot</groupId>
          <artifactId>spring-boot-starter-parent</artifactId>
          <version>2.3.7.RELEASE</version>
          <relativePath/>
      </parent>
      ```

   2. 解决@NotBlank 和 @Email 报错

      ```xml
      <dependency>
          <groupId>org.springframework.boot</groupId>
          <artifactId>spring-boot-starter-validation</artifactId>
      </dependency>
      ```

5. 修改数据库配置，连接到 gulimall_admin 的配置信息

### 前端管理 renren-fast-vue

1. 克隆项目

   > git clone git@gitee.com:renrenio/renren-fast-vue.git

2. 将项目拖到VSCode中

3. 统一配置

   1. nodeJs，

      > node 版本 14 可以解决所有的报错
      >
      > 关注 node.js 的 npm 功能
      >
      > NPM 是NodeJS的包管理工具，JS-NPM，Java-Maven

      - 官网下载安装，node -v 检查版本

      - 配置npm 淘宝镜像

        ```sh
        npm config set registry http://registry.npm.taobao.org/
        ```

      - 下载依赖包

        ```sh
        npm install
        ```

      - 报错处理

        ```sh
        npm install --save  -g core-js@^3
        ```

      - node-sass报错 是由于版本的问题，在package.json中可以解决

   2. Vue

### 代码生成 renren-generator

 1. 克隆项目

    > git clone git@gitee.com:renrenio/renren-generator.git

	2. 将项目拖到 idea 中

	3. 修改配置（以 product 模块为例子）

    - 修改 generator.properties

      ```properties
      #代码生成器，配置信息
      mainPath=com.atguigu
      #包名
      package=com.atguigu.gulimall
      moduleName=product
      #作者
      author=Mr.Ling
      #Email
      email=lingzhexi@163.com
      #表前缀(类名不会包含表前缀)
      tablePrefix=pms_
      ```

    - 修改 Controller.java.vm 模板

      ```java
      注释 @RequeiresPermissions 注解
      //@RequiresPermissions("${moduleName}:${pathName}:list")
      ```

    - 修改数据库配置( pms )

      ```yml
      spring:
        datasource:
          type: com.alibaba.druid.pool.DruidDataSource
          #MySQL配置
          driverClassName: com.mysql.cj.jdbc.Driver
          url: jdbc:mysql://localhost:13306/gulimall_pms?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=Asia/Shanghai
          username: root
          password: root
      ```

	4. 启动项目，生成代码

    - 点击生成代码

      ![image-20220407215910844](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204072159051.png)

    - 将代码放到 product 模块中

### 新增 gulimall-common

- 通用的依赖模块 ，product 模块引用该模块

  ```xml
  <dependency>
      <groupId>com.baomidou</groupId>
      <artifactId>mybatis-plus-boot-starter</artifactId>
      <version>3.3.1</version>
  </dependency>
  <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
      <version>1.18.22</version>
  </dependency>
  <dependency>
      <groupId>commons-lang</groupId>
      <artifactId>commons-lang</artifactId>
      <version>2.6</version>
  </dependency>
  <dependency>
      <groupId>org.apache.httpcomponents</groupId>
      <artifactId>httpcore</artifactId>
      <version>4.4.14</version>
  </dependency>
  <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-validation</artifactId>
      <version>2.3.7.RELEASE</version>
  </dependency>
  ```

## 整合Mybatis-pus

1. 导入依赖

   ```xml
   <dependency>
       <groupId>com.baomidou</groupId>
       <artifactId>mybatis-plus-boot-starter</artifactId>
       <version>3.3.1</version>
   </dependency>
   ```

2. 配置

   1. 配置数据源

      1. 导入MySql 驱动

         推荐使用 8 版本的Mysql connector![image-20220410002401508](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204100039304.png)

         ```xml
         <!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java -->
         <dependency>
             <groupId>mysql</groupId>
             <artifactId>mysql-connector-java</artifactId>
             <version>8.0.28</version>
         </dependency>
         ```

      2. 整合 application.yml

         ```yml
         server:
             port: 8080
         spring:
             application:
                 name: gulimall-product
             datasource:
                 username: root
                 password: root
                 url: jdbc:mysql://localhost:13306/gulimall_pms
                 driver-class-name: com.mysql.cj.jdbc.Driver
         
         ```

   2. 配置 mybaits-plus

      1. 主启动配置 @MapperScan("com.atguigu.gulimall.product.dao")

         ![image-20220410004352680](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204100043736.png) 

      2. 告诉 MyBatis-Plus ， sql 映射文件位置

         默认位置类路径下的 classpath*:/mapper/**/*.xml

         ![image-20220410004908204](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204100049256.png) 

         ```yml
         mybatis-plus:
         	mapper-locations: classpath:/mapper/**/*.xml
         ```

      3. 设置主键自增配置
      
         ```yml
         # 填写 id 自动联想出来
         mybatis-plus: 
          global-config:
                 db-config:
                     id-type: auto
         ```
   
   ​	**各模块最终需要依赖到 gulimall-common** 

# 整合微服务

 ![image-20220411213056325](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204112131562.png)

## 搭配方案：

- SpringCloud Alibaba - Nacos : 注册中心 （服务发现/注册）
- SpringCloud Alibaba - Nacos : 配置中心 （动态配置管理）
- SpringCloud - Ribbon :  负载均衡
- SpringCloud - Feign : 声明式 HTTP 客户端 （调用远程服务）
- SpringCloud Alibaba - Sentinel : 服务容错 （限流、降级、熔断）
- SpringCloud - Gateway : API 网关 （webflux 编程模式）
- SpringCloud - Sleuth : 调用链监控
- SpringCloud Alibaba - Seata : 原 Fescar 即分布式事务解决方案 	

阿里巴巴中文文档：[SpringCloud Alibab 中文文档](https://github.com/alibaba/spring-cloud-alibaba/blob/2021.x/README-zh.md)

## 版本选择：

![image-20220411215026972](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204112150099.png)  

SpringCloud - SpringBoot 版本对比（[SpringCloud 官网](https://spring.io/projects/spring-cloud)）

![image-20220411215056217](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204112150336.png) 

SpringCloud Alibaba - SpringBoot 版本对比 （ [SpringCloud Alibaba Github](https://github.com/alibaba/spring-cloud-alibaba/blob/2021.x/README-zh.md)）

![image-20220411220224816](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204112202930.png) 

将 SpringCloud Alibaba 依赖 加入 gulimall-common 中  

```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>2.1.0.RELEASE</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

 

## 注册中心

[nacos 注册中心](https://github.com/alibaba/spring-cloud-alibaba/blob/2021.x/spring-cloud-alibaba-docs/src/main/asciidoc-zh/nacos-discovery.adoc)

### 服务注册/发现 Nacos Discovery

1. 引入依赖，加入gulimall-common

   ```xml
   <dependency>
       <groupId>com.alibaba.cloud</groupId>
       <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
   </dependency>
   ```

   优惠卷模块引入 nacos discovery 依赖

    ![image-20220411222218474](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204112222593.png) 

2. 配置Nacos Server 地址

   ```yml
   spring:
   	cloud:
   		nacos:
   			discovery:
   				server-addr: 127.0.0.1:8848
   ```

3. 使用 @EnableDiscoveryClient 注解开启服务注册和发现
   ![image-20220411222803578](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204112228697.png) 

4. 查看注册的服务

   >  登录后台 127.0.0.1:8848/nacos 
   >
   > 用户信息：nacos/nacos

   ![image-20220411223200216](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204112232366.png) 

## 远程调用

1. 引入 open-feign

2. 编写一个接口，告诉SpringCloud 需要调用远程接口

   - 新建一个feign 包

   - 写一个接口

     ```java
     @FeignClient("gulimall-coupon") //表示 nacos 注册中心中的找到服务名为 gulimall-coupon 的服务
     public interface CouponFeignService {
     
         @RequestMapping("/coupon/coupon/member/coupon") // 找到优惠券服务中的该接口
         public R memberCoupons();
     }
     ```

3. 开启远程调用功能 

   在主启动中添加 @EnableFeignClients(basePackages="xx") xx表示指定feign的接口包

   ```java
   @EnableFeignClients(basePackages = "com.atguigu.gulimall.member.feign") //此时的basePackages 可以省略
   @EnableDiscoveryClient
   @MapperScan("com.atguigu.gulimall.member.dao")
   @SpringBootApplication
   public class GulimallMemberApplication {
   
       public static void main(String[] args) {
           SpringApplication.run(GulimallMemberApplication.class, args);
       }
   
   } 
   ```

4. 示例

   - 添加远程接口

     ```java
     @RestController
     @RequestMapping("coupon/coupon")
     public class CouponController {
         @Autowired
         private CouponService couponService;
     
         /**
          * 会员优惠券
          */
         @RequestMapping("/member/coupon")
         public R memberCoupons() {
             CouponEntity couponEntity = new CouponEntity();
             couponEntity.setCouponName("满100减10");
             return R.ok().put("coupons", Arrays.asList(couponEntity));
         }
     }
     ```

   - 添加调用接口

     ```java
     @RestController
     @RequestMapping("member/member")
     public class MemberController {
         @Autowired
         private MemberService memberService;
     
         @Autowired
         CouponFeignService couponFeignService;
     
         @RequestMapping("/coupons")
         public R test() {
             MemberEntity memberEntity = new MemberEntity();
             memberEntity.setNickname("张三");
             R r = couponFeignService.memberCoupons();
             return R.ok().put("member", memberEntity).put("coupons", r.get("coupons"));
         }
     }
     ```

   - 请求接口 localhost:8000/member/member/coupons

     

## 配置中心：动态管理配置

[nacos 配置中心文档](https://github.com/alibaba/spring-cloud-alibaba/blob/2021.x/spring-cloud-alibaba-examples/nacos-example/nacos-config-example/readme-zh.md)

1. 引入 Nacos Config  Starter

   ```xml
   <dependency>
       <groupId>com.alibaba.cloud</groupId>
       <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
   </dependency>
   ```

2. 创建 bootstrap.yml，配置 Nacos 元数据

   ```yml
   spring:
   	application:
   		name: gulimall-coupon
   	cloud:
   		nacos:
   			config:
   				server-addr: 127.0.0.1:8848
   ```

3. 配置中心 添加 数据集（Data Id） gulimall-coupon.properties ，默认规则，应用名.properties
   ![image-20220412213509978](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204122135151.png) 

   ![image-20220412214528762](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204122145876.png) 

4. 动态获取配置
    @RefreshScope ：动态获取并刷新配置

    @Value("${配置项的名}") ：获取到配置

   如果配置中心和当前应用都配置相同的项，优先使用配置中心的配置

   ```java
   @RefreshScope //动态刷新
   @RestController
   @RequestMapping("coupon/coupon")
   public class CouponController {
       @Autowired
       private CouponService couponService;
   
       @Value("${coupon.user.name}")
       private String name;
       @Value("${coupon.user.age}")
       private Integer age;
       @GetMapping("/test")
       public R test() {
           return R.ok().put("name",name).put("age",age);
       }
   }
   ```

5. 核心概念

   ![image-20220412220641506](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204122206664.png)

   - 命名空间：配置隔离 

     默认 public ：默认新增的所有都在该空间下

     1. 开发、测试、生产 ：利用命名空间来做环境隔离

        注意：在bootstrap.yml 配置中，需要使用那个命名空间下的配置

        ```yml
        spring.cloud.nacos.config.namespace=cc749289-b027-486f-bb6a-3febcabecbdb
        ```

        ![image-20220412220837375](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204122217795.png) 

     2. 每个服务应用之间相互隔离，管理微服务自己的配置
        ![image-20220412223231969](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204122232120.png)

   - 配置集：所有配置的集合

   - 配置集ID：类似文件名 （Data ID： 文件名）

   - 配置分组：默认所有的配置集都属于：DEFAULT_GROUP；

     - 组名：1111 、618 、1212

     - ![image-20220412224056530](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204122240653.png)

     - 添加分组配置

       ```properties
       spring.cloud.nacos.config.group=1111
       ```

   每个微服务创建自己的命名空间，使用配置分组区分环境，dev、test、prod 环境

   ![ ](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204122247441.png)

6. 同时加载多个配置集

   - 微服务任何配置信息，任何配置文件都可以放在配置中心中
     ![image-20220412233717240](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204122337360.png)

   - 只需要在 bootstrap.yml 说明 加载配置中心中的那些配置文件即可

     ```yml
     spring:
       appliation:
         name: gulimall-coupon
       cloud:
         nacos:
           config:
             server-addr: 127.0.0.1:8848
             namespace: d6545d08-333c-4806-bf43-6acc99acecc6
             # 数据库配置
             ext-config[0].data-id: datasource.yml
             ext-config[0].group: dev
             ext-config[0].refresh: true
             # mybatis 配置
             ext-config[1].data-id: mybatis.yml
             ext-config[1].group: dev
             ext-config[1].refresh: true
             # 其他配置
             ext-config[2].data-id: other.yml
             ext-config[2].group: dev
             ext-config[2].refresh: true
     ```

     ![image-20220412233550198](https://gitee.com/lingzhexi/blogImage/raw/master/img/2022/03/202204122335376.png)

   - @Value，@ConfigurationProperties  以前SpringBoot 任何方法从配置文件中获取值，都能使用

   - 配置中心有优先使用配置

## 网关

